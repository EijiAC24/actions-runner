name: Daily Blend Podcast

on:
  schedule:
    - cron: '0 21 * * *'
  workflow_dispatch:
    inputs:
      publish_date:
        description: 'Publish date (YYYY-MM-DD format). Leave empty for today.'
        required: false
        type: string
      skip_upload:
        description: 'Skip uploading to hosting'
        required: false
        default: 'false'
        type: boolean
      skip_shorts:
        description: 'Skip short video generation'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  generate-podcast:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      episode_number: ${{ steps.get-episode.outputs.episode }}
      thumbnail_url: ${{ steps.get-episode.outputs.thumbnail_url }}

    steps:
      - name: Checkout main project
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/DailyBlendPodcast
          token: ${{ secrets.CROSS_REPO_PAT }}
          path: 'main'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: main/package-lock.json

      - name: Install dependencies
        run: cd main && npm ci

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Build TypeScript
        run: cd main && npm run build

      - name: Run podcast automation
        working-directory: main
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID_DAILYBLEND }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          FTP_DIR_DAILYBLEND: '/tiidadottech/podcast/dailyblend/audio'
          HOSTING_URL_DAILYBLEND: 'http://okibai.heavy.jp/tiidadottech/podcast/dailyblend/audio'
          GITHUB_TOKEN: ${{ secrets.RSS_REPO_TOKEN }}
          GITHUB_REPO: EijiAC24/podcast-network-rss
          SKIP_UPLOAD: ${{ inputs.skip_upload }}
          PUBLISH_DATE: ${{ inputs.publish_date }}
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        run: npm start

      - name: Get episode number and thumbnail URL
        id: get-episode
        working-directory: main
        run: |
          if [ -f output/latest_episode.txt ]; then
            EPISODE=$(cat output/latest_episode.txt)
            echo "episode=$EPISODE" >> $GITHUB_OUTPUT
          else
            echo "episode=" >> $GITHUB_OUTPUT
          fi
          if [ -f output/latest_thumbnail_url.txt ]; then
            THUMBNAIL_URL=$(cat output/latest_thumbnail_url.txt)
            echo "thumbnail_url=$THUMBNAIL_URL" >> $GITHUB_OUTPUT
          else
            echo "thumbnail_url=" >> $GITHUB_OUTPUT
          fi

      - name: Commit RSS changes
        if: success()
        working-directory: main
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git fetch origin main
          git reset --soft origin/main
          git add output/rss/podcast.xml || true
          git diff --staged --quiet || git commit -m "Update Daily Blend RSS - $(date +%Y-%m-%d)"
          git push || true

      - name: Delete old workflow runs
        if: always()
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_PAT }}
        run: |
          gh run list --repo ${{ github.repository }} --workflow "Daily Blend Podcast" --json databaseId --jq '.[].databaseId' | while read id; do
            if [ "$id" != "${{ github.run_id }}" ]; then
              gh run delete "$id" --repo ${{ github.repository }} || true
            fi
          done

  trigger-short-videos:
    runs-on: ubuntu-latest
    needs: generate-podcast
    if: success() && needs.generate-podcast.outputs.episode_number != '' && inputs.skip_shorts != 'true'

    steps:
      - name: Trigger short video generation
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.CROSS_REPO_PAT }}
          repository: ${{ github.repository }}
          event-type: generate-daily-blend-shorts
          client-payload: '{"episode": "${{ needs.generate-podcast.outputs.episode_number }}", "thumbnail_url": "${{ needs.generate-podcast.outputs.thumbnail_url }}", "platform": "all"}'
